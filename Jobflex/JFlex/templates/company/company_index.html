{% extends 'base.html' %}
{% load static %}

{% block title %}Panel de Empresa{% endblock %}

{% block content %}
<div class="flex min-h-screen bg-gray-100 font-sans -mt-4">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-md hidden sm:block">
        <div class="p-6">
            <h2 class="text-xl font-bold text-dark">{{ company.name|default:"Mi Empresa" }}</h2>
            <p class="text-sm text-secondary">Panel de Control</p>
        </div>
        <nav class="mt-2">
            <a class="tab-link active-tab flex items-center px-6 py-3 text-dark hover:bg-gray-200" href="#" data-tab="dashboard">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                <span>Panel Principal</span>
            </a>
            
            <div id="jobs-menu">
                <a class="tab-link flex items-center justify-between px-6 py-3 text-dark hover:bg-gray-200 cursor-pointer" onclick="toggleSubmenu()">
                    <div class="flex items-center">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                        <span>Ofertas</span>
                    </div>
                    <svg id="submenu-arrow" class="w-4 h-4 transition-transform transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </a>
                <div id="jobs-submenu" class="hidden pl-12 bg-gray-50">
                    <a class="tab-link block py-2 text-secondary hover:text-dark" href="#" data-tab="all-jobs">Todos los empleos</a>
                    <a class="tab-link block py-2 text-secondary hover:text-dark" href="#" data-tab="postulaciones">Postulaciones</a>
                </div>
            </div>

            {% if is_admin %}
            <a class="tab-link flex items-center px-6 py-3 text-dark hover:bg-gray-200" href="#" data-tab="users">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-2a4 4 0 00-4-4H7a4 4 0 00-4 4v2"></path></svg>
                <span>Gestion Roles</span>
            </a>
            {% endif %}

            <a class="tab-link flex items-center px-6 py-3 text-dark hover:bg-gray-200" href="#" data-tab="interviews">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                <span>Entrevistas</span>
            </a>
            <a class="tab-link flex items-center px-6 py-3 text-dark hover:bg-gray-200" href="#" data-tab="analytics">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                <span>Análisis</span>
            </a>
            <a class="tab-link flex items-center px-6 py-3 text-dark hover:bg-gray-200" href="#" data-tab="tools">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span>Herramientas</span>
            </a>
        </nav>
    </aside>

    <!-- Main content -->
    <main class="flex-1 p-6 sm:p-10 overflow-y-auto">
        <!-- Dashboard Content -->
        <div id="dashboard" class="tab-content">
            <h1 class="text-3xl font-bold text-dark mb-6">Dashboard</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-primary">Empleos Activos</h3>
                    <p class="text-3xl font-bold text-dark mt-2">{{ active_jobs_count }}</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-primary">Nuevos Postulantes (7d)</h3>
                    <p class="text-3xl font-bold text-dark mt-2">{{ new_applicants_count }}</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-primary">Entrevistas Programadas</h3>
                    <p class="text-3xl font-bold text-dark mt-2">{{ upcoming_interviews_count }}</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-primary">Vistas de Ofertas</h3>
                    <p class="text-3xl font-bold text-dark mt-2">{{ total_offer_views }}</p>
                </div>
            </div>

            <!-- Quick Access Section -->
            <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-dark mb-4">Accesos Rápidos</h3>
                <div class="flex flex-wrap gap-4">
                    <button data-modal-toggle="create-job-modal" class="flex items-center space-x-3 bg-gray-100 hover:bg-gray-200 text-dark font-semibold py-3 px-5 rounded-lg transition-colors">
                        <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        <span>Crear Empleo</span>
                    </button>
                    <button class="tab-link flex items-center space-x-3 bg-gray-100 hover:bg-gray-200 text-dark font-semibold py-3 px-5 rounded-lg transition-colors" data-tab="interviews">
                        <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <span>Ver Entrevistas</span>
                    </button>
                    {% if is_admin %}
                    <button class="tab-link flex items-center space-x-3 bg-gray-100 hover:bg-gray-200 text-dark font-semibold py-3 px-5 rounded-lg transition-colors" data-tab="users">
                        <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-2a4 4 0 00-4-4H7a4 4 0 00-4 4v2"></path></svg>
                        <span>Gestionar Miembros</span>
                    </button>
                    <button data-modal-toggle="invitation-modal" class="flex items-center space-x-3 bg-gray-100 hover:bg-gray-200 text-dark font-semibold py-3 px-5 rounded-lg transition-colors">
                        <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                        <span>Invitar Usuario</span>
                    </button>
                    <button data-modal-toggle="company-data-modal" class="flex items-center space-x-3 bg-gray-100 hover:bg-gray-200 text-dark font-semibold py-3 px-5 rounded-lg transition-colors">
                        <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                        <span>Datos de Empresa</span>
                    </button>
                    <a href="{% url 'company_profile' company_id=company.id_empresa %}" class="flex items-center space-x-3 bg-gray-100 hover:bg-gray-200 text-dark font-semibold py-3 px-5 rounded-lg transition-colors">
                        <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        <span>Ver Perfil Público</span>
                    </a>
                    {% endif %}
                </div>
            </div>

            <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-dark">Postulantes Recientes</h3>
                        <a href="#" class="text-sm text-primary hover:underline" onclick="event.preventDefault(); document.querySelector('.tab-link[data-tab=\'postulaciones\']').click();">Ver todos</a>
                    </div>
                    <div class="space-y-3">
                        {% for applicant in recent_applicants %}
                        <a href="{% url 'view_offer_applicants' applicant.offer_id %}" class="flex items-center p-2 -mx-2 rounded-md hover:bg-gray-50 transition-colors">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-full bg-gray-200 text-primary flex items-center justify-center">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                </div>
                            </div>
                            <div class="ml-4 flex-grow">
                                <p class="text-sm font-medium text-dark">{{ applicant.full_name }}</p>
                                <p class="text-xs text-secondary truncate">Postuló a: {{ applicant.job_title }}</p>
                            </div>
                            <div class="flex-shrink-0 text-right">
                                <p class="text-xs text-secondary">{{ applicant.date|timesince }} atrás</p>
                            </div>
                        </a>
                        {% empty %}
                        <p class="text-sm text-gray-500 py-4 text-center">No hay postulantes recientes.</p>
                        {% endfor %}
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-dark mb-4">Actividad Reciente</h3>
                    <div class="space-y-4">
                        {% for activity in recent_activities %}
                        {% if activity.tipo_notificacion.nombre_tipo != 'Nueva Postulación' %}
                        <a href="{{ activity.link_relacionado|default:'#' }}" class="flex items-start hover:bg-gray-50 p-2 rounded-md">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 rounded-full bg-gray-200 text-primary flex items-center justify-center">
                                    {% if activity.tipo_notificacion.nombre_tipo == 'Nueva Postulación' %}
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                    {% elif activity.tipo_notificacion.nombre_tipo == 'Invitación Aceptada' %}
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    {% else %}
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-dark">{{ activity.mensaje }}</p>
                                <p class="text-xs text-secondary">{{ activity.fecha_envio|timesince }} atrás</p>
                            </div>
                        </a>
                        {% endif %}
                        {% empty %}
                        <p class="text-sm text-gray-500">No hay actividad reciente.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-dark mb-4">Fuente de Candidatos</h3>
                    <div class="relative h-80">
                        <canvas id="candidatesSourceChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-dark mb-4">Candidatos por Mes</h3>
                    <div class="relative h-80">
                        <canvas id="monthlyApplicantsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

{% include 'company/partials/_all_jobs_content.html' %}

        <!-- Postulaciones Content -->
        <div id="postulaciones" class="tab-content hidden">
            <h1 class="text-3xl font-bold text-dark mb-6">Seleccionar Oferta para Ver Postulantes</h1>
            
            <!-- Filter Form -->
            <form method="GET" action="{% url 'company_index' %}" class="mb-6 bg-white p-4 rounded-lg shadow-md">
                <input type="hidden" name="tab" value="postulaciones">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="postulaciones-categoria-filter" class="block text-sm font-medium text-gray-700">Filtrar por Categoría</label>
                        <select id="postulaciones-categoria-filter" name="categoria" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md">
                            <option value="">Todas las categorías</option>
                            {% for categoria in all_categorias %}
                                <option value="{{ categoria.id_categoria }}" {% if filter_values.categoria == categoria.id_categoria|stringformat:"s" %}selected{% endif %}>
                                    {{ categoria.tipo_categoria }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="self-end flex items-center space-x-2">
                        <button type="submit" class="w-full md:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                            Filtrar
                        </button>
                        <a href="{% url 'company_index' %}?tab=postulaciones" class="w-full md:w-auto inline-flex items-center justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Limpiar
                        </a>
                    </div>
                </div>
            </form>

            <!-- Offers Grid -->
            <div id="postulaciones-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for offer in all_offers %}
                <a href="{% url 'view_offer_applicants' offer_id=offer.id_oferta %}" class="block p-6 bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300">
                    <div class="flex justify-between items-start">
                        <h4 class="text-lg font-bold text-dark truncate">{{ offer.titulo_puesto }}</h4>
                        {% if offer.estado == 'activa' %}
                            <span class="text-xs font-semibold py-1 px-2 rounded-full bg-green-100 text-green-800">Activa</span>
                        {% elif offer.estado == 'cerrada' %}
                            <span class="text-xs font-semibold py-1 px-2 rounded-full bg-red-100 text-red-800">Cerrada</span>
                        {% else %}
                            <span class="text-xs font-semibold py-1 px-2 rounded-full bg-gray-100 text-gray-800">{{ offer.estado|capfirst }}</span>
                        {% endif %}
                    </div>
                    <p class="text-sm text-gray-500 mt-1">{{ offer.categoria.tipo_categoria }}</p>
                    <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center">
                        <p class="text-sm font-medium text-gray-700">Postulantes</p>
                        <p class="text-lg font-bold text-primary">{{ offer.candidate_count }}</p>
                    </div>
                </a>
                {% empty %}
                <div class="col-span-full text-center py-12">
                    <p class="text-gray-500">No se encontraron ofertas que coincidan con los filtros seleccionados.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Users Content -->
        {% if is_admin %}
        {% include 'company/partials/_users_content.html' %}
        {% endif %}

        <!-- Other Tab Content (Placeholders) -->
        <div id="tags" class="tab-content hidden"><h1 class="text-3xl font-bold">Postulaciones</h1></div>
        <!-- Interviews Content -->
        <div id="interviews" class="tab-content hidden">
            <h1 class="text-3xl font-bold text-dark mb-6">Entrevistas</h1>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-dark">{{ calendar_context.current_month_name }}</h3>
                        <div class="flex space-x-2">
                            <a href="{% url 'company_index' %}?tab=interviews&year={{ calendar_context.prev_month.year }}&month={{ calendar_context.prev_month.month }}" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </a>
                            <a href="{% url 'company_index' %}?tab=interviews&year={{ calendar_context.next_month.year }}&month={{ calendar_context.next_month.month }}" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </a>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center">
                        <div class="text-xs font-medium text-gray-500">Lun</div>
                        <div class="text-xs font-medium text-gray-500">Mar</div>
                        <div class="text-xs font-medium text-gray-500">Mié</div>
                        <div class="text-xs font-medium text-gray-500">Jue</div>
                        <div class="text-xs font-medium text-gray-500">Vie</div>
                        <div class="text-xs font-medium text-gray-500">Sáb</div>
                        <div class="text-xs font-medium text-gray-500">Dom</div>
                        
                        {% for week in calendar_context.grid %}
                            {% for day in week %}
                                <div class="border rounded-lg p-2 h-28 overflow-y-auto text-left 
                                            {% if not day.is_current_month %}text-gray-400 bg-gray-50{% endif %}
                                            {% if day.is_today %}bg-primary text-white ring-2 ring-primary-dark{% endif %}">
                                    <span class="font-bold">{{ day.day }}</span>
                                    {% for interview in day.interviews %}
                                        <div class="text-xs mt-1 p-1 rounded 
                                                    {% if day.is_today %}bg-white/20{% else %}bg-blue-100 text-blue-800{% endif %}">
                                            <p class="font-semibold truncate">{{ interview.candidate_name }}</p>
                                            <p>{% if day.is_today %}{% else %}{{ interview.time }}{% endif %}</p>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-dark mb-4">Próximas Entrevistas</h3>
                    <div class="space-y-2">
                        {% for interview in upcoming_interviews %}
                            <div class="border rounded-lg">
                                <button type="button" class="interview-toggle w-full p-3 text-left hover:bg-gray-50 focus:outline-none">
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0">
                                            <div class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                            </div>
                                        </div>
                                        <div class="ml-4 flex-grow">
                                            <p class="text-sm font-medium text-dark">{{ interview.candidate_name }}</p>
                                            <p class="text-xs text-secondary">{{ interview.job_title }}</p>
                                            <p class="text-xs text-secondary">{{ interview.date|date:"d M, Y" }} - {{ interview.time|time:"H:i" }}</p>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <span class="text-xs font-semibold py-1 px-2 rounded-full 
                                                        {% if interview.modality == 'Online' %}bg-blue-100 text-blue-800
                                                        {% else %}bg-green-100 text-green-800{% endif %}">
                                                {{ interview.modality }}
                                            </span>
                                        </div>
                                    </div>
                                </button>
                                <div class="interview-details hidden p-3 border-t border-gray-200 bg-gray-50">
                                    {% if interview.modality == 'Online' and interview.url %}
                                        <p class="text-sm"><strong>Enlace de la reunión:</strong> <a href="{{ interview.url }}" target="_blank" class="text-primary hover:underline">{{ interview.url }}</a></p>
                                    {% elif interview.modality == 'Presencial' and interview.address %}
                                        <p class="text-sm"><strong>Dirección:</strong> {{ interview.address }}</p>
                                    {% else %}
                                        <p class="text-sm text-gray-500">No hay más detalles disponibles.</p>
                                    {% endif %}
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-sm text-gray-500">No hay entrevistas programadas próximamente.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <!-- Analytics Content -->
        <div id="analytics" class="tab-content hidden">
            {% include 'company/partials/_analytics_content.html' %}
        </div>
        <!-- Tools Content -->
        <div id="tools" class="tab-content hidden">
            <h1 class="text-3xl font-bold text-dark mb-6">Herramientas <span class="text-lg font-normal text-gray-500">(Próximamente)</span></h1>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center text-center opacity-50">
                    <div class="w-16 h-16 rounded-full bg-primary text-white flex items-center justify-center mb-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    </div>
                    <h3 class="text-lg font-semibold text-primary">Analizador de CVs</h3>
                    <p class="text-dark mt-2">Sube un CV y extrae la información relevante de forma automática para acelerar tu proceso de selección.</p>
                    <button class="mt-4 bg-gray-300 text-gray-500 font-bold py-2 px-4 rounded-lg cursor-not-allowed" disabled>Usar Herramienta</button>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center text-center opacity-50">
                    <div class="w-16 h-16 rounded-full bg-primary text-white flex items-center justify-center mb-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </div>
                    <h3 class="text-lg font-semibold text-primary">Automatización ATS</h3>
                    <p class="text-dark mt-2">Optimiza la selección revisando y estandarizando la estructura de los CVs recibidos.</p>
                    <button class="mt-4 bg-gray-300 text-gray-500 font-bold py-2 px-4 rounded-lg cursor-not-allowed" disabled>Configurar</button>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md flex flex-col items-center text-center opacity-50">
                    <div class="w-16 h-16 rounded-full bg-primary text-white flex items-center justify-center mb-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707.707M12 21v-1m0-16a9 9 0 110 18 9 9 0 010-18z"></path></svg>
                    </div>
                    <h3 class="text-lg font-semibold text-primary">Asistente IA para Descripciones</h3>
                    <p class="text-dark mt-2">Genera descripciones de trabajo atractivas y efectivas con la ayuda de inteligencia artificial.</p>
                    <button class="mt-4 bg-gray-300 text-gray-500 font-bold py-2 px-4 rounded-lg cursor-not-allowed" disabled>Probar Asistente</button>
                </div>
            </div>
        </div>
    </main>
</div>

<footer class="bg-dark text-light-gray py-4 mt-auto">
    <div class="container mx-auto text-center text-sm">
        <p>&copy; 2025 JobFlex. Todos los derechos reservados.</p>
    </div>
</footer>

<!-- Modals Section -->

{% include 'company/partials/_create_job_modal.html' %}

{% if is_admin %}
{% include 'company/partials/_company_data_modal.html' %}
{% endif %}

{% include 'company/partials/_user_modals.html' %}


{% endblock %}


{% block extra_js %}
    {{ block.super }}
<style>
    .active-tab {
        background-color: #e5e7eb; /* bg-gray-200 */
        border-left: 4px solid #8CA01A; /* border-primary */
        color: #111827; /* text-gray-900 */
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- OTHER PAGE LOGIC (MODALS, TABS, ETC.) ---
    document.addEventListener('click', function(event) {
        const toggleAttr = event.target.closest('[data-modal-toggle]')?.getAttribute('data-modal-toggle');
        if (toggleAttr) document.getElementById(toggleAttr)?.classList.remove('hidden');
        const hideAttr = event.target.closest('[data-modal-hide]')?.getAttribute('data-modal-hide');
        if (hideAttr) document.getElementById(hideAttr)?.classList.add('hidden');
    });
    
    window.toggleSubmenu = function () {
        document.getElementById('jobs-submenu').classList.toggle('hidden');
        document.getElementById('submenu-arrow').classList.toggle('rotate-180');
    };

    const tabLinks = document.querySelectorAll('.tab-link');
    const tabContents = document.querySelectorAll('.tab-content');
    function switchTab(tabId) {
        if (!tabId) return;
        tabLinks.forEach(item => {
            if (item.dataset.tab) item.classList.toggle('active-tab', item.dataset.tab === tabId);
        });
        tabContents.forEach(content => {
            content.classList.toggle('hidden', content.id !== tabId);
        });

        // Special handling for the analytics tab to activate its sub-tab
        if (tabId === 'analytics') {
            const analyticsTabContent = document.getElementById('analytics-content'); // Get the content div inside the tab
            if (analyticsTabContent) {
                const analyticsSubTabLinks = analyticsTabContent.querySelectorAll('.analytics-sub-tab-link');
                const analyticsSubTabContents = analyticsTabContent.querySelectorAll('#analytics-tab-content > div');

                // Find the currently active analytics sub-tab
                let activeSubTabId = 'general-analytics'; // Default to general-analytics
                const urlParams = new URLSearchParams(window.location.search);
                const subTabParam = urlParams.get('analytics_sub_tab');
                if (subTabParam && analyticsTabContent.querySelector(`#${subTabParam}-tab`)) {
                    activeSubTabId = subTabParam;
                }

                analyticsSubTabLinks.forEach(link => {
                    link.classList.remove('active', 'border-primary', 'hover:text-gray-600', 'hover:border-gray-300');
                    link.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                    if (link.id === `${activeSubTabId}-tab`) {
                        link.classList.add('active', 'border-primary');
                        link.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
                    }
                });

                analyticsSubTabContents.forEach(content => {
                    content.classList.add('hidden');
                    if (content.id === activeSubTabId) {
                        content.classList.remove('hidden');
                    }
                });
            }
        }
    }
    tabLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const tabId = link.dataset.tab;
            if (tabId) switchTab(tabId);
        });
    });
    
    // --- LOGIC TO OPEN MODALS AND SET ACTIVE TAB FROM URL ---
    const urlParams = new URLSearchParams(window.location.search);
    const offerIdToEdit = urlParams.get('edit_offer');
    const activeTab = urlParams.get('tab') || 'dashboard'; // Default to dashboard
    
    // Special handling for interview navigation
    if (urlParams.has('year') && urlParams.has('month')) {
        switchTab('interviews');
    } else if (offerIdToEdit) {
        // If editing, always switch to the all-jobs tab first
        switchTab('all-jobs');
        
        // Find the corresponding edit button and click it to open the modal
        const editButton = document.querySelector(`.edit-offer-btn[data-offer-id="${offerIdToEdit}"]`);
        if (editButton) {
            editButton.click();
        }
    } else {
        // Otherwise, default to the specified or default tab
        switchTab(activeTab);
    }

    // --- INTERVIEW ACCORDION LOGIC ---
    document.querySelectorAll('.interview-toggle').forEach(button => {
        button.addEventListener('click', () => {
            const details = button.nextElementSibling;
            details.classList.toggle('hidden');
        });
    });

    // --- CHART.JS LOGIC ---
    const sourceCanvas = document.getElementById('candidatesSourceChart');
    if (sourceCanvas) {
        new Chart(sourceCanvas, {
            type: 'doughnut',
            data: {
                labels: {{ candidate_source_labels|safe }},
                datasets: [{
                    label: 'Fuente de Candidatos',
                    data: {{ candidate_source_data|safe }},
                    backgroundColor: [
                        'rgba(140, 160, 26, 0.7)',
                        'rgba(26, 140, 160, 0.7)',
                        'rgba(216, 217, 221, 0.7)',
                        'rgba(245, 158, 11, 0.7)',
                        'rgba(59, 130, 246, 0.7)',
                    ],
                    borderColor: [
                        'rgba(140, 160, 26, 1)',
                        'rgba(26, 140, 160, 1)',
                        'rgba(216, 217, 221, 1)',
                        'rgba(245, 158, 11, 1)',
                        'rgba(59, 130, 246, 1)',
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false,
                    }
                }
            }
        });
    }

    const monthlyCanvas = document.getElementById('monthlyApplicantsChart');
    if (monthlyCanvas) {
        new Chart(monthlyCanvas, {
            type: 'bar',
            data: {
                labels: {{ monthly_applicants_labels|safe }},
                datasets: [{
                    label: 'Postulantes por Mes',
                    data: {{ monthly_applicants_data|safe }},
                    backgroundColor: 'rgba(26, 140, 160, 0.5)',
                    borderColor: 'rgba(26, 140, 160, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // --- NEW GENERAL ANALYTICS CHARTS ---
    const generalFunnelData = JSON.parse('{{ general_hiring_funnel_data|safe }}');
    const generalHiringFunnelChartCanvas = document.getElementById('generalHiringFunnelChart');

    if (generalHiringFunnelChartCanvas && generalFunnelData) {
        const funnelLabels = ['Enviada', 'En Proceso', 'Entrevista', 'Aceptada', 'Rechazada'];
        const funnelCounts = [
            generalFunnelData['enviada'],
            generalFunnelData['en proceso'],
            generalFunnelData['entrevista'],
            generalFunnelData['aceptada'],
            generalFunnelData['rechazada']
        ];
        new Chart(generalHiringFunnelChartCanvas, {
            type: 'bar',
            data: {
                labels: funnelLabels,
                datasets: [{
                    label: 'Cantidad de Postulantes',
                    data: funnelCounts,
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.7)', // Blue - Enviada
                        'rgba(245, 158, 11, 0.7)', // Amber - En Proceso
                        'rgba(168, 85, 247, 0.7)', // Purple - Entrevista
                        'rgba(34, 197, 94, 0.7)',  // Green - Aceptada
                        'rgba(239, 68, 68, 0.7)'   // Red - Rechazada
                    ],
                    borderColor: [
                        'rgba(59, 130, 246, 1)',
                        'rgba(245, 158, 11, 1)',
                        'rgba(168, 85, 247, 1)',
                        'rgba(34, 197, 94, 1)',
                        'rgba(239, 68, 68, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { display: false }
                },
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });
    }

    const applicantAgeDistributionChartCanvas = document.getElementById('applicantAgeDistributionChart');
    if (applicantAgeDistributionChartCanvas) {
        new Chart(applicantAgeDistributionChartCanvas, {
            type: 'bar',
            data: {
                labels: JSON.parse('{{ applicant_age_labels|safe }}'),
                datasets: [{
                    label: 'Número de Postulantes',
                    data: JSON.parse('{{ applicant_age_data|safe }}'),
                    backgroundColor: 'rgba(140, 160, 26, 0.7)',
                    borderColor: 'rgba(140, 160, 26, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    const applicantRegionDistributionChartCanvas = document.getElementById('applicantRegionDistributionChart');
    if (applicantRegionDistributionChartCanvas) {
        new Chart(applicantRegionDistributionChartCanvas, {
            type: 'pie',
            data: {
                labels: JSON.parse('{{ applicant_region_labels|safe }}'),
                datasets: [{
                    label: 'Postulantes por Región',
                    data: JSON.parse('{{ applicant_region_data|safe }}'),
                    backgroundColor: [
                        'rgba(140, 160, 26, 0.7)', 'rgba(26, 140, 160, 0.7)', 'rgba(216, 217, 221, 0.7)',
                        'rgba(245, 158, 11, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 99, 132, 0.7)', 'rgba(255, 205, 86, 0.7)', 'rgba(75, 192, 192, 0.7)',
                        'rgba(54, 162, 235, 0.7)', 'rgba(201, 203, 207, 0.7)'
                    ],
                    borderColor: [
                        'rgba(140, 160, 26, 1)', 'rgba(26, 140, 160, 1)', 'rgba(216, 217, 221, 1)',
                        'rgba(245, 158, 11, 1)', 'rgba(59, 130, 246, 1)', 'rgba(153, 102, 255, 1)',
                        'rgba(255, 99, 132, 1)', 'rgba(255, 205, 86, 1)', 'rgba(75, 192, 192, 1)',
                        'rgba(54, 162, 235, 1)', 'rgba(201, 203, 207, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: false }
                }
            }
        });
    }

    // --- Populate General Metrics Cards ---
    const conversionRateCard = document.getElementById('conversion-rate-card');
    if (conversionRateCard) {
        conversionRateCard.innerText = `{{ general_conversion_rate }}%`;
    }
    
    const timeToHireCard = document.getElementById('time-to-hire-card');
    if (timeToHireCard) {
        const avgTimeToHire = {{ avg_time_to_hire_days|default_if_none:"null" }};
        if (avgTimeToHire !== null) {
            timeToHireCard.innerText = `${avgTimeToHire} días`;
        } else {
            timeToHireCard.innerText = 'N/A';
        }
    }

    const uniqueApplicantsCount = document.getElementById('unique_applicants_count');
    if (uniqueApplicantsCount) {
        uniqueApplicantsCount.innerText = '{{ unique_applicants_count }}';
    }


    // --- Offer-specific Analytics Logic ---
    const offerSelect = document.getElementById('offer-select');
    if(offerSelect) {
        const offerAnalysisLoadingSpinner = document.getElementById('offer-analysis-loading-spinner');
        const selectedOfferAnalyticsData = document.getElementById('selected-offer-analytics-data');
        const noOfferSelectedMessage = document.getElementById('no-offer-selected');

        let offerHiringFunnelChartInstance = null;
        let peakApplicationTimesChartInstance = null;
        let offerApplicantAgeDistributionChartInstance = null;
        let offerApplicantRegionDistributionChartInstance = null;

        offerSelect.addEventListener('change', function() {
            const offerId = this.value;
            if (offerId) {
                if(offerAnalysisLoadingSpinner) offerAnalysisLoadingSpinner.classList.remove('hidden');
                if(selectedOfferAnalyticsData) selectedOfferAnalyticsData.classList.add('hidden');
                if(noOfferSelectedMessage) noOfferSelectedMessage.classList.add('hidden');

                fetch(`/company/analytics/offer/${offerId}/`) // You'll need to create this URL/view
                    .then(response => response.json())
                    .then(data => {
                        if(offerAnalysisLoadingSpinner) offerAnalysisLoadingSpinner.classList.add('hidden');
                        if(selectedOfferAnalyticsData) selectedOfferAnalyticsData.classList.remove('hidden');

                        // Populate Offer-specific Metrics Cards
                        const offerConversionRateCard = document.getElementById('offer-conversion-rate-card');
                        if(offerConversionRateCard) offerConversionRateCard.innerText = `${data.offer_conversion_rate}%`;

                        const offerTimeToHireCard = document.getElementById('offer-time-to-hire-card');
                        if (offerTimeToHireCard) {
                            if (data.offer_avg_time_to_hire_days !== null) {
                                offerTimeToHireCard.innerText = `${data.offer_avg_time_to_hire_days} días`;
                            } else {
                                offerTimeToHireCard.innerText = 'N/A';
                            }
                        }

                        const offerUniqueApplicantsCard = document.getElementById('offer-unique-applicants-card');
                        if(offerUniqueApplicantsCard) offerUniqueApplicantsCard.innerText = data.offer_unique_applicants_count;

                        // Destroy old charts if they exist
                        if (offerHiringFunnelChartInstance) offerHiringFunnelChartInstance.destroy();
                        if (peakApplicationTimesChartInstance) peakApplicationTimesChartInstance.destroy();
                        if (offerApplicantAgeDistributionChartInstance) offerApplicantAgeDistributionChartInstance.destroy();
                        if (offerApplicantRegionDistributionChartInstance) offerApplicantRegionDistributionChartInstance.destroy();

                        // Offer-specific Hiring Funnel Chart
                        const offerHiringFunnelChartCanvas = document.getElementById('offerHiringFunnelChart');
                        if(offerHiringFunnelChartCanvas) {
                            const offerFunnelLabels = ['Enviada', 'En Proceso', 'Entrevista', 'Aceptada', 'Rechazada'];
                            const offerFunnelCounts = [
                                data.offer_hiring_funnel_data['enviada'], data.offer_hiring_funnel_data['en proceso'],
                                data.offer_hiring_funnel_data['entrevista'], data.offer_hiring_funnel_data['aceptada'],
                                data.offer_hiring_funnel_data['rechazada']
                            ];
                            offerHiringFunnelChartInstance = new Chart(offerHiringFunnelChartCanvas, {
                                type: 'bar',
                                data: {
                                    labels: offerFunnelLabels,
                                    datasets: [{
                                        label: 'Cantidad de Postulantes', data: offerFunnelCounts,
                                        backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(168, 85, 247, 0.7)', 'rgba(34, 197, 94, 0.7)', 'rgba(239, 68, 68, 0.7)'],
                                        borderColor: ['rgba(59, 130, 246, 1)', 'rgba(245, 158, 11, 1)', 'rgba(168, 85, 247, 1)', 'rgba(34, 197, 94, 1)', 'rgba(239, 68, 68, 1)'],
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                                    plugins: { legend: { display: false }, title: { display: false } },
                                    scales: { x: { beginAtZero: true } }
                                }
                            });
                        }

                        // Peak Application Times Chart
                        const peakApplicationTimesChartCanvas = document.getElementById('peakApplicationTimesChart');
                        if(peakApplicationTimesChartCanvas) {
                            const peakTimesData = data.peak_application_times_data;
                            const chartData = [];
                            const daysOfWeek = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
                            for (let day = 0; day < 7; day++) {
                                for (let hour = 0; hour < 24; hour++) {
                                    const count = peakTimesData[day] ? peakTimesData[day][hour] || 0 : 0;
                                    if (count > 0) chartData.push({ x: hour, y: day, r: count * 2 + 5 });
                                }
                            }
                            peakApplicationTimesChartInstance = new Chart(peakApplicationTimesChartCanvas, {
                                type: 'bubble',
                                data: {
                                    datasets: [{
                                        label: 'Postulaciones', data: chartData,
                                        backgroundColor: 'rgba(140, 160, 26, 0.7)', borderColor: 'rgba(140, 160, 26, 1)',
                                    }]
                                },
                                options: {
                                    responsive: true, maintainAspectRatio: false,
                                    scales: {
                                        x: { title: { display: true, text: 'Hora del Día (0-23)' }, min: -0.5, max: 23.5, ticks: { stepSize: 1 } },
                                        y: { title: { display: true, text: 'Día de la Semana' }, min: -0.5, max: 6.5, ticks: { stepSize: 1, callback: (value) => daysOfWeek[value] } }
                                    },
                                    plugins: {
                                        tooltip: { callbacks: { label: (context) => `Día: ${daysOfWeek[context.raw.y]}, Hora: ${context.raw.x}, Postulaciones: ${(context.raw.r - 5) / 2}` } }
                                    }
                                }
                            });
                        }

                        // Offer-specific Applicant Age Distribution Chart
                        const offerApplicantAgeDistributionChartCanvas = document.getElementById('offerApplicantAgeDistributionChart');
                        if (offerApplicantAgeDistributionChartCanvas) {
                            offerApplicantAgeDistributionChartInstance = new Chart(offerApplicantAgeDistributionChartCanvas, {
                                type: 'bar',
                                data: {
                                    labels: data.offer_applicant_age_labels,
                                    datasets: [{
                                        label: 'Número de Postulantes', data: data.offer_applicant_age_data,
                                        backgroundColor: 'rgba(140, 160, 26, 0.7)', borderColor: 'rgba(140, 160, 26, 1)', borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true, maintainAspectRatio: false,
                                    plugins: { legend: { display: false }, title: { display: false } },
                                    scales: { y: { beginAtZero: true } }
                                }
                            });
                        }

                        // Offer-specific Applicant Region Distribution Chart
                        const offerApplicantRegionDistributionChartCanvas = document.getElementById('offerApplicantRegionDistributionChart');
                        if(offerApplicantRegionDistributionChartCanvas) {
                            offerApplicantRegionDistributionChartInstance = new Chart(offerApplicantRegionDistributionChartCanvas, {
                                type: 'pie',
                                data: {
                                    labels: data.offer_applicant_region_labels,
                                    datasets: [{
                                        label: 'Postulantes por Región', data: data.offer_applicant_region_data,
                                        backgroundColor: ['rgba(140, 160, 26, 0.7)', 'rgba(26, 140, 160, 0.7)', 'rgba(216, 217, 221, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(255, 205, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(201, 203, 207, 0.7)'],
                                        borderColor: ['rgba(140, 160, 26, 1)', 'rgba(26, 140, 160, 1)', 'rgba(216, 217, 221, 1)', 'rgba(245, 158, 11, 1)', 'rgba(59, 130, 246, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 99, 132, 1)', 'rgba(255, 205, 86, 1)', 'rgba(75, 192, 192, 1)', 'rgba(54, 162, 235, 1)', 'rgba(201, 203, 207, 1)'],
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true, maintainAspectRatio: false,
                                    plugins: { legend: { position: 'top' }, title: { display: false } }
                                }
                            });
                        }
                    })
                    .catch(error => {
                        if(offerAnalysisLoadingSpinner) offerAnalysisLoadingSpinner.classList.add('hidden');
                        if(selectedOfferAnalyticsData) selectedOfferAnalyticsData.classList.add('hidden');
                        if(noOfferSelectedMessage) {
                            noOfferSelectedMessage.classList.remove('hidden');
                            noOfferSelectedMessage.innerHTML = `<p class="text-red-500">Error al cargar el análisis para la oferta: ${error.message}</p>`;
                        }
                        console.error('Error fetching offer analytics:', error);
                    });
            } else {
                if(selectedOfferAnalyticsData) selectedOfferAnalyticsData.classList.add('hidden');
                if(noOfferSelectedMessage) {
                     noOfferSelectedMessage.classList.remove('hidden');
                    noOfferSelectedMessage.innerHTML = '<p>Por favor, selecciona una oferta para ver su análisis detallado.</p>';
                }
                if (offerHiringFunnelChartInstance) offerHiringFunnelChartInstance.destroy();
                if (peakApplicationTimesChartInstance) peakApplicationTimesChartInstance.destroy();
                if (offerApplicantAgeDistributionChartInstance) offerApplicantAgeDistributionChartInstance.destroy();
                if (offerApplicantRegionDistributionChartInstance) offerApplicantRegionDistributionChartInstance.destroy();
            }
        });

        const initialOfferId = urlParams.get('offer_id_for_analytics');
        if (initialOfferId) {
            offerSelect.value = initialOfferId;
            offerSelect.dispatchEvent(new Event('change'));
        }
    }
});
</script>
{% endblock %}