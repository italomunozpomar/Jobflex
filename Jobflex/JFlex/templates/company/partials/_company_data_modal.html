{% if is_admin %}
<div id="company-data-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col">
        <!-- Modal Header -->
        <div class="sticky top-0 bg-white px-6 py-4 flex items-center justify-between border-b z-10 flex-shrink-0">
            <div>
                <h3 class="text-2xl font-bold text-dark">Actualizar Datos de la Empresa</h3>
                <p class="text-secondary text-sm mt-1">Modifica la información principal de tu empresa</p>
            </div>
            <button data-modal-hide="company-data-modal" type="button" class="text-gray-500 hover:bg-gray-100 rounded-lg p-2 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <form method="POST" action="{% url 'company_index' %}" enctype="multipart/form-data" class="flex-grow overflow-y-auto">
            <div class="p-6">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_company_data">

                <!-- Tab Navigation -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button type="button" class="modal-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-primary text-primary" data-tab-target="#importante">
                            Información Importante
                        </button>
                        <button type="button" class="modal-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab-target="#otra">
                            Otra Información
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div id="importante" class="modal-tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <div>
                                <label for="{{ company_data_form.nombre_comercial.id_for_label }}" class="block text-sm font-semibold text-dark mb-1">Nombre Comercial <span class="text-red-500">*</span></label>
                                {{ company_data_form.nombre_comercial }}
                            </div>
                            <div>
                                <label for="{{ company_data_form.sitio_web.id_for_label }}" class="block text-sm font-semibold text-dark mb-1">Sitio Web</label>
                                {{ company_data_form.sitio_web }}
                            </div>
                            <div>
                                <label for="{{ company_data_form.resumen_empresa.id_for_label }}" class="block text-sm font-semibold text-dark mb-1">Resumen Empresa</label>
                                {{ company_data_form.resumen_empresa }}
                            </div>
                            <div>
                                <label for="{{ company_data_form.mision.id_for_label }}" class="block text-sm font-semibold text-dark mb-1">Misión</label>
                                {{ company_data_form.mision }}
                            </div>
                            <div>
                                <label for="{{ company_data_form.vision.id_for_label }}" class="block text-sm font-semibold text-dark mb-1">Visión</label>
                                {{ company_data_form.vision }}
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div class="bg-gray-50 rounded-lg p-4 border">
                                <h4 class="text-sm font-semibold text-dark mb-3">Logo de Empresa</h4>
                                <div class="flex flex-col items-center">
                                    <div class="w-32 h-32 rounded-full bg-white border-2 flex items-center justify-center overflow-hidden shadow-sm mb-4" id="logo-container">
                                        <img id="logo-preview" src="{{ company.imagen_perfil|default:'' }}" alt="Logo actual" class="w-full h-full object-cover {% if not company.imagen_perfil %}hidden{% endif %}">
                                        <div id="logo-placeholder" class="w-full h-full bg-gray-200 flex items-center justify-center text-gray-400 {% if company.imagen_perfil %}hidden{% endif %}">
                                            <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14"></path></svg>
                                        </div>
                                    </div>
                                    <label for="{{ company_data_form.imagen_perfil.id_for_label }}" class="w-full cursor-pointer bg-white border rounded-lg p-2 text-center text-sm font-semibold text-dark hover:bg-gray-50">Cambiar Logo</label>
                                    <div class="hidden">{{ company_data_form.imagen_perfil }}</div>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4 border">
                                <h4 class="text-sm font-semibold text-dark mb-3">Banner de Portada</h4>
                                <div class="mb-4 rounded-lg overflow-hidden border-2" id="banner-container">
                                    <img id="banner-preview" src="{{ company.imagen_portada|default:'' }}" alt="Banner actual" class="w-full h-40 object-cover {% if not company.imagen_portada %}hidden{% endif %}">
                                    <div id="banner-placeholder" class="w-full h-40 bg-gray-200 flex items-center justify-center text-gray-400 {% if company.imagen_portada %}hidden{% endif %}">
                                        <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    </div>
                                </div>
                                <label for="{{ company_data_form.imagen_portada.id_for_label }}" class="w-full cursor-pointer bg-white border rounded-lg p-2 text-center text-sm font-semibold text-dark hover:bg-gray-50">Cambiar Banner</label>
                                <div class="hidden">{{ company_data_form.imagen_portada }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="otra" class="modal-tab-content hidden">
                    <div class="space-y-4 max-w-md mx-auto">
                        <div>
                            <label for="{{ company_data_form.rut_empresa.id_for_label }}" class="block text-sm font-semibold text-dark mb-1">RUT Empresa</label>
                            {{ company_data_form.rut_empresa }}
                        </div>
                        <div>
                            <label for="{{ company_data_form.razon_social.id_for_label }}" class="block text-sm font-semibold text-dark mb-1">Razón Social</label>
                            {{ company_data_form.razon_social }}
                        </div>
                        <div>
                            <label for="{{ company_data_form.telefono.id_for_label }}" class="block text-sm font-semibold text-dark mb-1">Teléfono</label>
                            {{ company_data_form.telefono }}
                        </div>
                        <div class="relative">
                            <label for="rubro-search" class="block text-sm font-semibold text-dark mb-1">Rubro o Industria</label>
                            <input type="text" id="rubro-search" class="mt-1 block w-full p-3 border border-light-gray rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" 
                                   value="{{ company_data_form.instance.rubro.nombre_rubro|default:'' }}"
                                   placeholder="Busca un rubro...">
                            {{ company_data_form.rubro }}
                            <div id="rubro-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-60 overflow-y-auto hidden"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="{{ company_data_form.region.id_for_label }}" class="block text-sm font-semibold text-dark mb-1">Región</label>
                                {{ company_data_form.region }}
                            </div>
                            <div>
                                <label for="{{ company_data_form.ciudad.id_for_label }}" class="block text-sm font-semibold text-dark mb-1">Ciudad</label>
                                {{ company_data_form.ciudad }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-end space-x-3 p-6 border-t flex-shrink-0">
                <button data-modal-hide="company-data-modal" type="button" class="px-6 py-2.5 bg-gray-100 text-dark font-medium rounded-lg hover:bg-gray-200">Cancelar</button>
                <button type="submit" class="px-6 py-2.5 bg-primary text-white font-medium rounded-lg hover:bg-primary/90 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    Guardar Cambios
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Image Preview Logic ---
    function setupImagePreview(inputId, previewId, placeholderId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        const placeholder = document.getElementById(placeholderId);
        if (!input || !preview) return;

        input.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    if(placeholder) placeholder.classList.add('hidden');
                }
                reader.readAsDataURL(this.files[0]);
            }
        });
    }
    setupImagePreview('{{ company_data_form.imagen_perfil.id_for_label }}', 'logo-preview', 'logo-placeholder');
    setupImagePreview('{{ company_data_form.imagen_portada.id_for_label }}', 'banner-preview', 'banner-placeholder');

    // --- Dependent Dropdown for Region/City ---
    const regionSelect = document.getElementById('{{ company_data_form.region.id_for_label }}');
    const ciudadSelect = document.getElementById('{{ company_data_form.ciudad.id_for_label }}');
    if (regionSelect && ciudadSelect) {
        const urlTemplate = "{% url 'get_ciudades' 0 %}";
        const populateCities = (regionId, initialCiudadId = null) => {
            ciudadSelect.innerHTML = '<option value="">Selecciona una ciudad</option>';
            if (!regionId) return;
            const url = urlTemplate.replace('0', regionId);
            fetch(url).then(response => response.json()).then(data => {
                if (data.error) { console.error(data.error); return; }
                data.forEach(ciudad => {
                    const option = new Option(ciudad.nombre, ciudad.id_ciudad);
                    if (String(ciudad.id_ciudad) === String(initialCiudadId)) option.selected = true;
                    ciudadSelect.add(option);
                });
            }).catch(error => console.error('Error fetching cities:', error));
        };
        regionSelect.addEventListener('change', () => populateCities(regionSelect.value));
        if (regionSelect.value) {
            const initialCiudadId = regionSelect.getAttribute('data-city-id');
            populateCities(regionSelect.value, initialCiudadId);
        }
    }

    // --- Modal Tab Logic ---
    const modal = document.getElementById('company-data-modal');
    if (modal) {
        const tabButtons = modal.querySelectorAll('.modal-tab-btn');
        const tabContents = modal.querySelectorAll('.modal-tab-content');
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.dataset.tabTarget;
                tabButtons.forEach(btn => {
                    btn.classList.remove('border-primary', 'text-primary');
                    btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                });
                button.classList.add('border-primary', 'text-primary');
                button.classList.remove('border-transparent', 'text-gray-500');
                tabContents.forEach(content => content.classList.toggle('hidden', content.id !== targetId.substring(1)));
            });
        });
    }

    // --- Searchable Rubro Logic ---
    try {
        const rubroSearchInput = document.getElementById('rubro-search');
        const rubroSelect = document.getElementById('{{ company_data_form.rubro.id_for_label }}');
        const rubroResultsContainer = document.getElementById('rubro-results');
        
        // Inyectar el JSON directamente en una variable de JavaScript
        const rubroData = JSON.parse('{{ all_rubros_json|escapejs }}');

        if (rubroSearchInput && rubroSelect && rubroResultsContainer) {
            console.log("Rubro data loaded:", rubroData);

            rubroSelect.style.display = 'none';

            const normalizeText = (str) => {
                if (!str) return '';
                return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            };

            const updateResults = (query) => {
                const normalizedQuery = normalizeText(query);
                console.log("Normalized query:", normalizedQuery);
                rubroResultsContainer.innerHTML = '';

                if (!Array.isArray(rubroData)) {
                    console.error("rubroData is not an array:", rubroData);
                    return;
                }

                const filteredRubros = rubroData.filter(rubro => {
                    const normalizedRubroName = normalizeText(rubro.nombre_rubro);
                    return normalizedRubroName.includes(normalizedQuery);
                });
                
                console.log("Filtered rubros:", filteredRubros);

                if (filteredRubros.length > 0) {
                    filteredRubros.forEach(rubro => {
                        const item = document.createElement('div');
                        item.classList.add('p-2', 'cursor-pointer', 'hover:bg-gray-100', 'text-sm');
                        item.textContent = rubro.nombre_rubro;
                        item.dataset.id = rubro.pk;
                        item.addEventListener('click', function() {
                            rubroSearchInput.value = this.textContent;
                            rubroSelect.value = this.dataset.id;
                            rubroResultsContainer.classList.add('hidden');
                        });
                        rubroResultsContainer.appendChild(item);
                    });
                } else {
                    const noResult = document.createElement('div');
                    noResult.classList.add('p-2', 'text-gray-500', 'text-sm');
                    noResult.textContent = 'No se encontraron rubros.';
                    rubroResultsContainer.appendChild(noResult);
                }
                rubroResultsContainer.classList.remove('hidden');
            };

            rubroSearchInput.addEventListener('focus', function() {
                updateResults(''); // Show all results on focus
            });

            rubroSearchInput.addEventListener('input', function() {
                updateResults(this.value);
            });

            document.addEventListener('click', function(e) {
                if (!rubroSearchInput.contains(e.target) && !rubroResultsContainer.contains(e.target)) {
                    rubroResultsContainer.classList.add('hidden');
                }
            });
        } else {
            console.error("One or more Rubro search elements are missing from the DOM.");
        }
    } catch (e) {
        console.error("Error initializing rubro search:", e);
    }
});
</script>
{% endif %}