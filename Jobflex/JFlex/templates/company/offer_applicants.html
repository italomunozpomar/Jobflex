{% extends 'base.html' %}
{% load static %}

{% block title %}Postulantes para {{ offer.titulo_puesto }}{% endblock %}

{% block content %}
<div class="flex flex-col h-screen bg-gray-100 font-sans">
    <!-- Header -->
    <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10">
        <div>
            <h1 class="text-2xl font-bold text-dark">Tablero de Postulantes</h1>
            <p class="text-md text-secondary">{{ offer.titulo_puesto }}</p>
        </div>
        <a href="{% url 'company_index' %}?tab=all-jobs" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            <svg class="w-5 h-5 mr-2 -ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            Volver a Ofertas
        </a>
    </header>

    <!-- Kanban Board -->
    <main class="flex-1 flex overflow-x-auto p-4 space-x-4">
        {% for column in kanban_data %}
        <div class="kanban-column flex-shrink-0 w-72 bg-gray-200 rounded-lg flex flex-col">
            <div class="p-3 font-semibold text-dark border-b border-gray-300">
                {{ column.status_name }}
                <span class="text-sm font-normal text-gray-500">{{ column.applicants|length }}</span>
            </div>
            <div class="kanban-cards p-2 space-y-3 overflow-y-auto flex-1" data-status="{{ column.status_key }}">
                {% for applicant in column.applicants %}
                <div class="kanban-card bg-white p-3 rounded-md shadow cursor-grab active:cursor-grabbing" data-id="{{ applicant.postulacion_id }}">
                    <p class="font-semibold text-dark mb-2">{{ applicant.full_name }}</p>
                    <div class="text-xs text-gray-600 space-y-1 mb-3">
                        <p><strong class="font-medium text-gray-700">Ubicación:</strong> {{ applicant.location }}</p>
                        <p><strong class="font-medium text-gray-700">Edad:</strong> {{ applicant.age|default:"N/A" }} años</p>
                    </div>
                    <p class="text-xs text-gray-500 mb-3">Postuló el: {{ applicant.application_date|date:"d M, Y" }}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-xs py-1 px-2 rounded-full {% if applicant.availability == 'Disponible' %} bg-green-100 text-green-800 {% else %} bg-gray-200 text-gray-800 {% endif %}">
                            {{ applicant.availability }}
                        </span>
                        <div class="flex items-center space-x-1">
                            <button class="view-cv-btn p-1 text-gray-500 hover:text-primary" title="Ver CV" data-postulacion-id="{{ applicant.postulacion_id }}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></button>
                            <button class="schedule-interview-btn p-1 text-gray-500 hover:text-primary" title="Agendar Entrevista" data-postulacion-id="{{ applicant.postulacion_id }}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                <div class="empty-column-placeholder text-center p-4 text-sm text-gray-500 {% if column.applicants %}hidden{% endif %}">
                    No hay postulantes en este estado.
                </div>
            </div>
        </div>
        {% endfor %}
    </main>
</div>

<!-- Universal CV Preview Modal -->
<div id="cv-preview-modal" tabindex="-1" aria-hidden="true" class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative w-full max-w-7xl max-h-full">
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700 flex flex-col max-h-full">
            <!-- Modal header -->
            <div class="flex items-start justify-between p-4 border-b rounded-t dark:border-gray-600">
                <div>
                    <h3 id="modal-cv-name" class="text-xl font-semibold text-gray-900 dark:text-white"></h3>
                </div>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="cv-preview-modal">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>
            <!-- Modal body -->
            <div id="modal-loader" class="p-6 text-center">
                <svg class="animate-spin h-8 w-8 text-primary mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="mt-2 text-sm text-gray-500">Cargando datos del postulante...</p>
            </div>
            <div id="modal-body-content" class="hidden flex-1 lg:grid lg:grid-cols-4 gap-6 p-6 overflow-y-auto">
                <!-- Left Column: CV Content -->
                <div id="cv-content-wrapper" class="lg:col-span-3 bg-white p-6 rounded-lg overflow-y-auto shadow-inner">
                    <div id="cv-content-area" class="h-full"></div>
                </div>
                <!-- Right Column: Personal Data -->
                <div id="personal-data-wrapper" class="lg:col-span-1 bg-gray-50 p-4 rounded-lg overflow-y-auto mt-6 lg:mt-0">
                    <h4 class="font-bold text-lg mb-4">Datos del Postulante</h4>
                    <div class="space-y-3 text-sm">
                        <p><strong class="block text-gray-800">Nombre:</strong> <span id="modal-candidate-name" class="text-gray-600"></span></p>
                        <p><strong class="block text-gray-800">Email:</strong> <span id="modal-candidate-email" class="text-gray-600"></span></p>
                        <p><strong class="block text-gray-800">Teléfono:</strong> <span id="modal-candidate-phone" class="text-gray-600"></span></p>
                        <p><strong class="block text-gray-800">RUT:</strong> <span id="modal-candidate-rut" class="text-gray-600"></span></p>
                        <p><strong class="block text-gray-800">Ubicación:</strong> <span id="modal-candidate-location" class="text-gray-600"></span></p>
                        <p><strong class="block text-gray-800">Edad:</strong> <span id="modal-candidate-age" class="text-gray-600"></span></p>
                        <p><strong class="block text-gray-800">Disponibilidad:</strong> <span id="modal-candidate-availability" class="text-gray-600"></span></p>
                        <p id="linkedin-container" class="hidden"><strong class="block text-gray-800">LinkedIn:</strong> <a id="modal-candidate-linkedin" href="#" target="_blank" class="text-primary hover:underline"></a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Interview Modal -->
<div id="schedule-interview-modal" tabindex="-1" aria-hidden="true" class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative w-full max-w-lg max-h-full">
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
            <form id="schedule-interview-form">
                <!-- Modal header -->
                <div class="flex items-start justify-between p-4 border-b rounded-t dark:border-gray-600">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Agendar Entrevista</h3>
                    <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center" data-modal-hide="schedule-interview-modal">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        <span class="sr-only">Close modal</span>
                    </button>
                </div>
                <!-- Modal body -->
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="interview-date" class="block mb-2 text-sm font-medium text-gray-900">Fecha</label>
                            <input type="date" id="interview-date" name="fecha" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5" required>
                        </div>
                        <div>
                            <label for="interview-time" class="block mb-2 text-sm font-medium text-gray-900">Hora</label>
                            <input type="time" id="interview-time" name="hora" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5" required>
                        </div>
                    </div>
                    <div>
                        <label for="interview-recruiter" class="block mb-2 text-sm font-medium text-gray-900">Nombre del Entrevistador</label>
                        <input type="text" id="interview-recruiter" name="entrevistador" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="interview-modality" class="block mb-2 text-sm font-medium text-gray-900">Modalidad</label>
                        <select id="interview-modality" name="modalidad" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5">
                            <option value="Online">Online</option>
                            <option value="Presencial">Presencial</option>
                        </select>
                    </div>
                    <div id="online-fields">
                        <div>
                            <label for="interview-platform" class="block mb-2 text-sm font-medium text-gray-900">Plataforma</label>
                            <input type="text" id="interview-platform" name="plataforma" placeholder="Ej: Google Meet, Zoom, Teams" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5">
                        </div>
                        <div class="mt-4">
                            <label for="interview-url" class="block mb-2 text-sm font-medium text-gray-900">URL de la Reunión</label>
                            <input type="url" id="interview-url" name="url" placeholder="https://" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5">
                        </div>
                    </div>
                    <div id="presencial-fields" class="hidden">
                        <div>
                            <label for="interview-address" class="block mb-2 text-sm font-medium text-gray-900">Dirección</label>
                            <input type="text" id="interview-address" name="direccion" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5">
                        </div>
                    </div>
                </div>
                <!-- Modal footer -->
                <div class="flex items-center p-6 space-x-2 border-t border-gray-200 rounded-b dark:border-gray-600">
                    <button type="submit" class="text-white bg-primary hover:bg-opacity-90 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Agendar</button>
                    <button data-modal-hide="schedule-interview-modal" type="button" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.0/flowbite.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Helper Functions ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // --- CV Preview Modal Logic ---
    const cvPreviewModalEl = document.getElementById('cv-preview-modal');
    const cvPreviewModal = new Modal(cvPreviewModalEl);
    const cvLoader = document.getElementById('modal-loader');
    const cvModalBody = document.getElementById('modal-body-content');
    const cvContentArea = document.getElementById('cv-content-area');

    function renderCreatedCvPreview(container, cvData) {
        let html = '';
        const p = cvData.personalData;
        const fullName = `${p.firstName || ''} ${p.secondName || ''} ${p.lastName || ''} ${p.motherLastName || ''}`.trim();
        
        html += `<header class="text-center border-b-2 border-gray-800 pb-4"><h1 class="text-3xl font-bold tracking-wider uppercase text-gray-800">${fullName}</h1><p class="text-lg font-medium text-gray-600">${cvData.objective || ''}</p></header>`;

        if (cvData.objective) {
            html += `<section class="mt-6"><h2 class="text-lg font-bold uppercase tracking-wider border-b border-gray-300 pb-1 mb-2">Objetivo Profesional</h2><p class="text-sm text-gray-700 whitespace-pre-wrap">${cvData.objective}</p></section>`;
        }
        if (cvData.experience && cvData.experience.length > 0) {
            html += '<section class="mt-6"><h2 class="text-lg font-bold uppercase tracking-wider border-b border-gray-300 pb-1 mb-2">Experiencia Profesional</h2>';
            cvData.experience.forEach(exp => {
                const description = exp.description ? exp.description.split('\\n').map(item => `<li class="text-gray-700">${item}</li>`).join('') : '';
                html += `<div class="text-sm mb-4"><p class="font-semibold text-md text-gray-900">${exp.position}</p><h3 class="font-bold">${exp.company} - ${exp.location}</h3><p class="italic text-xs text-gray-500">${exp.start_date} - ${exp.end_date}</p><ul class="list-disc list-inside mt-2 space-y-1 pl-2">${description}</ul></div>`;
            });
            html += '</section>';
        }
        if (cvData.education && cvData.education.length > 0) {
            html += '<section class="mt-6"><h2 class="text-lg font-bold uppercase tracking-wider border-b border-gray-300 pb-1 mb-2">Educación</h2>';
            cvData.education.forEach(edu => {
                html += `<div class="text-sm mb-3"><h3 class="font-bold text-md">${edu.degree}</h3><p>${edu.institution}</p><p class="italic text-xs text-gray-500">${edu.start_year} - ${edu.end_year}</p></div>`;
            });
            html += '</section>';
        }
        if (cvData.skills && (cvData.skills.hard.length > 0 || cvData.skills.soft.length > 0)) {
            html += '<section class="mt-6"><h2 class="text-lg font-bold uppercase tracking-wider border-b border-gray-300 pb-1 mb-2">Habilidades</h2>';
            if (cvData.skills.hard.length > 0) {
                html += '<p class="font-semibold mb-2">Habilidades Técnicas:</p><ul class="list-disc list-inside ml-4 space-y-1">';
                cvData.skills.hard.forEach(skill => { html += `<li>${skill}</li>`; });
                html += '</ul>';
            }
            if (cvData.skills.soft.length > 0) {
                html += '<p class="font-semibold mt-3 mb-2">Competencias:</p><ul class="list-disc list-inside ml-4 space-y-1">';
                cvData.skills.soft.forEach(skill => { html += `<li>${skill}</li>`; });
                html += '</ul>';
            }
            html += '</section>';
        }
        if (cvData.languages && cvData.languages.length > 0) {
            html += '<section class="mt-6"><h2 class="text-lg font-bold uppercase tracking-wider border-b border-gray-300 pb-1 mb-2">Idiomas</h2>';
            cvData.languages.forEach(lang => { html += `<p class="text-sm"><span class="font-semibold">${lang.language}:</span> ${lang.level}</p>`; });
            html += '</section>';
        }
        if (cvData.certifications && cvData.certifications.length > 0) {
            html += '<section class="mt-6"><h2 class="text-lg font-bold uppercase tracking-wider border-b border-gray-300 pb-1 mb-2">Certificaciones</h2>';
            cvData.certifications.forEach(cert => { html += `<p class="text-sm"><span class="font-semibold">${cert.cert_name}</span>, ${cert.issuer} (${cert.year})</p>`; });
            html += '</section>';
        }
        if (cvData.projects && cvData.projects.length > 0) {
            html += '<section class="mt-6"><h2 class="text-lg font-bold uppercase tracking-wider border-b border-gray-300 pb-1 mb-2">Proyectos</h2>';
            cvData.projects.forEach(proj => {
                html += `<div class="text-sm mb-4"><h3 class="font-bold text-md">${proj.project_name}</h3><p class="italic text-xs text-gray-500">${proj.period}</p>${proj.role ? `<p class="italic font-semibold">${proj.role}</p>` : ''}<p class="mt-1">${proj.description}</p>${proj.link ? `<a href="${proj.link}" class="text-primary hover:underline" target="_blank">Ver proyecto</a>` : ''}</div>`;
            });
            html += '</section>';
        }
        if (cvData.volunteering && cvData.volunteering.length > 0) {
            html += '<section class="mt-6"><h2 class="text-lg font-bold uppercase tracking-wider border-b border-gray-300 pb-1 mb-2">Voluntariado</h2>';
            cvData.volunteering.forEach(vol => { html += `<div class="text-sm mb-3"><h3 class="font-bold text-md">${vol.organization}</h3><p class="italic">${vol.role}</p><p class="italic text-xs text-gray-500">${vol.start_date} - ${vol.end_date}</p></div>`; });
            html += '</section>';
        }
        if (cvData.references && cvData.references.length > 0) {
            html += '<section class="mt-6"><h2 class="text-lg font-bold uppercase tracking-wider border-b border-gray-300 pb-1 mb-2">Referencias</h2>';
            cvData.references.forEach(ref => {
                html += `<div class="text-sm mb-3"><h3 class="font-bold text-md">${ref.name}</h3><p class="italic">${ref.position}</p><p class="mt-1">Tel: ${ref.phone} | Email: ${ref.email}</p>${ref.linkedin_url ? `<a href="${ref.linkedin_url}" class="text-primary hover:underline" target="_blank">Ver Perfil de LinkedIn</a>` : ''}</div>`;
            });
            html += '</section>';
        }
        container.innerHTML = html;
    }

    document.querySelectorAll('.view-cv-btn').forEach(button => {
        button.addEventListener('click', function () {
            const postulacionId = this.dataset.postulacionId;
            cvModalBody.classList.add('hidden');
            cvLoader.classList.remove('hidden');
            cvPreviewModal.show();

            fetch(`/api/applicant/${postulacionId}/details/`)
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        const data = result.data;
                        document.getElementById('modal-cv-name').innerText = `Curriculum Vitae de ${data.personal_data.full_name}`;
                        document.getElementById('modal-candidate-name').innerText = data.personal_data.full_name;
                        document.getElementById('modal-candidate-email').innerText = data.personal_data.email;
                        document.getElementById('modal-candidate-phone').innerText = data.personal_data.phone;
                        document.getElementById('modal-candidate-rut').innerText = data.personal_data.rut || 'No especificado';
                        document.getElementById('modal-candidate-location').innerText = data.personal_data.location;
                        document.getElementById('modal-candidate-age').innerText = data.personal_data.age ? `${data.personal_data.age} años` : 'No especificada';
                        document.getElementById('modal-candidate-availability').innerText = data.personal_data.availability;
                        
                        const linkedinContainer = document.getElementById('linkedin-container');
                        const linkedinLink = document.getElementById('modal-candidate-linkedin');
                        if (data.personal_data.linkedin_url) {
                            linkedinLink.href = data.personal_data.linkedin_url;
                            linkedinLink.innerText = 'Ver Perfil';
                            linkedinContainer.classList.remove('hidden');
                        } else {
                            linkedinContainer.classList.add('hidden');
                        }

                        cvContentArea.innerHTML = '';
                        if (data.cv_data.cv_type === 'subido') {
                            const embed = document.createElement('iframe');
                            embed.src = data.cv_data.content;
                            embed.className = 'w-full h-full min-h-[80vh]';
                            cvContentArea.appendChild(embed);
                        } else {
                            renderCreatedCvPreview(cvContentArea, data.cv_data.content);
                        }
                        cvLoader.classList.add('hidden');
                        cvModalBody.classList.remove('hidden');
                    }
                });
        });
    });

    // --- Interview Modal Logic ---
    const interviewModalEl = document.getElementById('schedule-interview-modal');
    const interviewModal = new Modal(interviewModalEl);
    const interviewForm = document.getElementById('schedule-interview-form');
    const modalitySelect = document.getElementById('interview-modality');
    const onlineFields = document.getElementById('online-fields');
    const presencialFields = document.getElementById('presencial-fields');
    let currentPostulacionId = null;

    modalitySelect.addEventListener('change', function() {
        onlineFields.classList.toggle('hidden', this.value !== 'Online');
        presencialFields.classList.toggle('hidden', this.value !== 'Presencial');
    });

    document.querySelectorAll('.schedule-interview-btn').forEach(button => {
        button.addEventListener('click', function() {
            currentPostulacionId = this.dataset.postulacionId;
            interviewForm.reset();
            onlineFields.classList.remove('hidden');
            presencialFields.classList.add('hidden');
            interviewModal.show();
        });
    });

    interviewForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(interviewForm);
        const data = Object.fromEntries(formData.entries());

        fetch(`/api/postulacion/${currentPostulacionId}/schedule_interview/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                alert('Entrevista agendada exitosamente.');
                interviewModal.hide();
                const card = document.querySelector(`.kanban-card[data-id='${currentPostulacionId}']`);
                const entrevistaColumn = document.querySelector(`.kanban-cards[data-status='entrevista']`);
                if (card && entrevistaColumn && card.parentElement !== entrevistaColumn) {
                    entrevistaColumn.appendChild(card);
                    updateColumnPlaceholder(card.parentElement);
                    updateColumnPlaceholder(entrevistaColumn);
                }
            } else {
                alert(`Error: ${result.message}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ocurrió un error al agendar la entrevista.');
        });
    });

    // --- Drag and Drop Logic ---
    function updateColumnPlaceholder(container) {
        const placeholder = container.querySelector('.empty-column-placeholder');
        const cardCount = container.querySelectorAll('.kanban-card').length;
        if (placeholder) {
            placeholder.classList.toggle('hidden', cardCount > 0);
        }
    }

    document.querySelectorAll('.kanban-cards').forEach(container => {
        new Sortable(container, {
            group: 'kanban',
            animation: 150,
            ghostClass: 'bg-blue-100',
            onEnd: function (evt) {
                const card = evt.item;
                const fromColumnContainer = evt.from;
                const toColumnContainer = evt.to;
                
                const postulacionId = card.dataset.id;
                const newStatus = toColumnContainer.dataset.status;

                updateColumnPlaceholder(fromColumnContainer);
                updateColumnPlaceholder(toColumnContainer);

                fetch(`/api/postulacion/${postulacionId}/update_status/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    body: JSON.stringify({ new_status: newStatus })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status !== 'success') {
                        fromColumnContainer.appendChild(card);
                        updateColumnPlaceholder(fromColumnContainer);
                        updateColumnPlaceholder(toColumnContainer);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    fromColumnContainer.appendChild(card);
                    updateColumnPlaceholder(fromColumnContainer);
                    updateColumnPlaceholder(toColumnContainer);
                });
            }
        });
    });
});
</script>
{% endblock %}