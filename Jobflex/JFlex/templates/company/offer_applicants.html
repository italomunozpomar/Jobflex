{% extends 'base.html' %}
{% load static %}

{% block title %}Postulantes para {{ offer.titulo_puesto }}{% endblock %}

{% block extra_css %}
<style>
    .loader-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 50;
    }
    .loader-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0056b3;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div style="display:none;">
    {% csrf_token %}
</div>
<div class="flex flex-col h-screen bg-gray-100 font-sans -mt-4">
    <header class="bg-white shadow-sm p-4 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-dark">Tablero de Postulantes</h1>
            <p class="text-md text-secondary">{{ offer.titulo_puesto }}</p>
        </div>
        <div class="flex items-center space-x-4">
            <div class="flex items-center">
                <span class="text-sm font-medium text-gray-700 mr-2">Modo Automático</span>
                <label for="auto-mode-toggle" class="inline-flex relative items-center cursor-pointer">
                    <input type="checkbox" value="" id="auto-mode-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                </label>
            </div>
            <a href="{% url 'company_index' %}?tab=all-jobs" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                <svg class="w-5 h-5 mr-2 -ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Volver a Ofertas
            </a>
        </div>
    </header>

    <!-- Filtro de Búsqueda -->
    <div class="px-4 pb-2">
        <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <input type="text" id="applicant-search-filter" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-primary focus:border-primary sm:text-sm" placeholder="Buscar por nombre...">
        </div>
    </div>

    <div class="flex flex-1">
        <!-- Contenedor del Kanban Board -->
        <main id="kanban-container" class="flex-1 flex overflow-x-auto p-4 space-x-4">
            {% for column in kanban_data %}
            <div class="kanban-column flex-shrink-0 w-72 bg-gray-200 rounded-lg flex flex-col" data-status-key="{{ column.status_key }}">
                <div class="p-3 font-semibold text-dark border-b border-gray-300 flex justify-between items-center">
                    <div class="flex items-center">
                        {{ column.status_name }}
                        <span class="ml-2 text-sm font-normal text-gray-500" data-counter>{{ column.applicants|length }}</span>
                    </div>
                    <div class="relative group z-40">
                        <svg class="w-5 h-5 text-gray-400 hover:text-gray-600 cursor-pointer" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div class="absolute top-full right-0 mt-2 w-60 bg-white text-gray-700 text-xs rounded-lg p-3 border border-gray-200 shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
                            {{ column.tooltip }}
                            <div class="absolute bottom-full right-3 w-3 h-3 bg-white border-t border-l border-gray-200 rotate-45" style="margin-bottom: -7px;"></div>
                        </div>
                    </div>
                </div>
                <div class="kanban-cards p-2 space-y-3 overflow-y-auto flex-1" data-status="{{ column.status_key }}">
                    {% for applicant in column.applicants %}
                    <div class="kanban-card bg-white p-3 rounded-md shadow cursor-grab active:cursor-grabbing" data-id="{{ applicant.postulacion_id }}" data-has-interview="{{ applicant.has_interview|yesno:'true,false' }}">
                        <p class="font-semibold text-dark mb-2">{{ applicant.full_name }}</p>
                        <div class="text-xs text-gray-600 space-y-1 mb-3">
                            <p><strong class="font-medium text-gray-700">Ubicación:</strong> {{ applicant.location }}</p>
                            <p><strong class="font-medium text-gray-700">Edad:</strong> {{ applicant.age|default:"N/A" }} años</p>
                        </div>
                        <p class="text-xs text-gray-500 mb-3">Postuló el: {{ applicant.application_date|date:"d M, Y" }}</p>
                        <div class="flex justify-between items-center">
                             <div class="flex items-center space-x-2">
                                <span class="availability-span text-xs py-1 px-2 rounded-full {% if applicant.availability == 'Disponible' %} bg-green-100 text-green-800 {% else %} bg-gray-200 text-gray-800 {% endif %}">
                                    {{ applicant.availability }}
                                </span>
                                {% if applicant.has_interview %}
                                <span class="interview-badge text-xs py-1 px-2 rounded-full bg-yellow-100 text-yellow-800">
                                    Entrevista Agendada
                                </span>
                                {% endif %}
                            </div>
                            <div class="flex items-center space-x-1" data-button-container>
                                <button class="view-cv-btn p-1 text-gray-500 hover:text-primary" title="Ver CV" data-postulacion-id="{{ applicant.postulacion_id }}"><svg style="pointer-events: none;" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></button>
                                {% if column.status_key == 'en proceso' %}
                                    <button class="schedule-interview-btn p-1 text-gray-500 hover:text-primary" title="Agendar Entrevista" data-postulacion-id="{{ applicant.postulacion_id }}"><svg style="pointer-events: none;" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></button>
                                {% elif column.status_key == 'entrevista' %}
                                    {% if applicant.has_interview %}
                                        <button class="manage-interview-btn p-1 text-gray-500 hover:text-primary" title="Gestionar Entrevista" data-postulacion-id="{{ applicant.postulacion_id }}"><svg style="pointer-events: none;" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                                    {% else %}
                                        <button class="schedule-interview-btn p-1 text-gray-500 hover:text-primary" title="Agendar Entrevista" data-postulacion-id="{{ applicant.postulacion_id }}"><svg style="pointer-events: none;" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></button>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    <div class="empty-column-placeholder text-center p-4 text-sm text-gray-500 {% if column.applicants %}hidden{% endif %}">
                        No hay postulantes en este estado.
                    </div>
                </div>
            </div>
            {% endfor %}
        </main>

        <!-- Panel de Filtros -->
        <aside id="filter-sidebar" class="w-64 bg-white p-4 border-l border-gray-200 overflow-y-auto">
            <h3 class="text-lg font-semibold text-dark mb-4">Filtros</h3>
            
            <!-- Filtro por Estado -->
            <div id="status-filter-container">
                <h4 class="font-medium text-sm text-gray-800 mb-2">Mostrar Estados</h4>
                <div class="space-y-2">
                    {% for column in kanban_data %}
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" class="form-checkbox h-5 w-5 text-primary rounded border-gray-300 focus:ring-primary" value="{{ column.status_key }}" checked>
                            <span class="ml-2 text-sm text-gray-700">{{ column.status_name }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <hr class="my-6 border-gray-200">

            <!-- Filtro por Disponibilidad -->
            <div id="availability-filter-container">
                <h4 class="font-medium text-sm text-gray-800 mb-2">Disponibilidad</h4>
                <div class="space-y-2">
                    <div>
                        <label class="inline-flex items-center">
                            <input type="radio" class="form-radio h-4 w-4 text-primary border-gray-300 focus:ring-primary" name="availability" value="todos" checked>
                            <span class="ml-2 text-sm text-gray-700">Todos</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="radio" class="form-radio h-4 w-4 text-primary border-gray-300 focus:ring-primary" name="availability" value="Disponible">
                            <span class="ml-2 text-sm text-gray-700">Disponible</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="radio" class="form-radio h-4 w-4 text-primary border-gray-300 focus:ring-primary" name="availability" value="No Disponible">
                            <span class="ml-2 text-sm text-gray-700">No Disponible</span>
                        </label>
                    </div>
                </div>
            </div>

            <hr class="my-6 border-gray-200">

            <!-- Acciones en Lote -->
            <div>
                <h4 class="font-medium text-sm text-gray-800 mb-2">Acciones en Lote</h4>
                <button id="move-unavailable-btn" class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Mover 'No Disponibles' a Rechazados
                </button>
            </div>
        </aside>
    </div>
</div>

{% include 'company/partials/_cv_preview_modal.html' %}
{% include 'company/partials/_schedule_interview_modal.html' %}
{% include 'company/partials/_manage_interview_modal.html' %}

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.0/flowbite.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. STATE & CONFIG
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    let isAutoModeEnabled = false;
    let currentPostulacionId = null;
    let currentInterviewId = null;

    // 2. MODAL INSTANCES
    const cvPreviewModalEl = document.getElementById('cv-preview-modal');
    const scheduleModalEl = document.getElementById('schedule-interview-modal');
    const manageModalEl = document.getElementById('manage-interview-modal');
    const cvPreviewModal = new Modal(cvPreviewModalEl);
    const scheduleModal = new Modal(scheduleModalEl);
    const manageModal = new Modal(manageModalEl);

    // 3. UI UPDATE FUNCTIONS
    function showLoader(modalElement) {
        const loader = modalElement.querySelector('.loader-overlay');
        if (loader) loader.classList.remove('hidden');
    }
    function hideLoader(modalElement) {
        const loader = modalElement.querySelector('.loader-overlay');
        if (loader) loader.classList.add('hidden');
    }

    function updateColumnPlaceholder(container) {
        if (!container) return;
        const placeholder = container.querySelector('.empty-column-placeholder');
        const cardCount = container.querySelectorAll('.kanban-card').length;
        if (placeholder) placeholder.classList.toggle('hidden', cardCount > 0);
    }

    function updateAllPlaceholders() {
        document.querySelectorAll('.kanban-cards').forEach(updateColumnPlaceholder);
    }

    function updateColumnCounts() {
        document.querySelectorAll('.kanban-column').forEach(column => {
            const counter = column.querySelector('[data-counter]');
            const cardContainer = column.querySelector('.kanban-cards');
            if (counter && cardContainer) {
                const cardCount = cardContainer.querySelectorAll('.kanban-card').length;
                counter.textContent = cardCount;
            }
        });
    }

    function updateCardUI(card) {
        const buttonContainer = card.querySelector('[data-button-container]');
        if (!buttonContainer) return;

        const postulacionId = card.dataset.id;
        const hasInterview = card.dataset.hasInterview === 'true';
        const status = card.parentElement.dataset.status;

        const viewCvBtn = `<button class="view-cv-btn p-1 text-gray-500 hover:text-primary" title="Ver CV" data-postulacion-id="${postulacionId}"><svg style="pointer-events: none;" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></button>`;
        const scheduleBtn = `<button class="schedule-interview-btn p-1 text-gray-500 hover:text-primary" title="Agendar Entrevista" data-postulacion-id="${postulacionId}"><svg style="pointer-events: none;" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></button>`;
        const manageBtn = `<button class="manage-interview-btn p-1 text-gray-500 hover:text-primary" title="Gestionar Entrevista" data-postulacion-id="${postulacionId}"><svg style="pointer-events: none;" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>`;
        
        let newButtonsHtml = viewCvBtn;
        if (status === 'en proceso') {
            newButtonsHtml += scheduleBtn;
        } else if (status === 'entrevista') {
            if (hasInterview) newButtonsHtml += manageBtn;
            else newButtonsHtml += scheduleBtn;
        }
        buttonContainer.innerHTML = newButtonsHtml;

        const badge = card.querySelector('.interview-badge');
        if (hasInterview) {
            if (!badge) {
                const badgeContainer = card.querySelector('.flex.items-center.space-x-2');
                const newBadge = document.createElement('span');
                newBadge.className = 'interview-badge text-xs py-1 px-2 rounded-full bg-yellow-100 text-yellow-800';
                newBadge.textContent = 'Entrevista Agendada';
                badgeContainer.appendChild(newBadge);
            }
        } else {
            if (badge) badge.remove();
        }
    }

    // 4. MODAL HANDLERS
    function openCvModal(postulacionId) {
        cvPreviewModal.show();
        showLoader(cvPreviewModalEl);
        const cvModalBody = document.getElementById('modal-body-content');
        const cvContentArea = document.getElementById('cv-content-area');
        
        // Clear previous content
        document.getElementById('modal-cv-name').innerText = '';
        cvContentArea.innerHTML = '';
        if(cvModalBody) cvModalBody.classList.add('hidden');
        ['modal-personal-name', 'modal-personal-email', 'modal-personal-phone', 'modal-personal-rut', 'modal-personal-location', 'modal-personal-age', 'modal-personal-availability'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerText = '';
        });
        const linkedinContainer = document.getElementById('linkedin-container');
        const personalLinkedin = document.getElementById('modal-personal-linkedin');
        if(linkedinContainer) linkedinContainer.classList.add('hidden');
        if(personalLinkedin) {
            personalLinkedin.href = '#';
            personalLinkedin.innerText = '';
        }

        fetch(`/api/applicant/${postulacionId}/details/`)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(result => {
                if (result.status === 'success') {
                    const data = result.data;
                    document.getElementById('modal-cv-name').innerText = `CV de ${data.personal_data.full_name}`;
                    
                    // Populate personal data
                    document.getElementById('modal-personal-name').innerText = data.personal_data.full_name;
                    document.getElementById('modal-personal-email').innerText = data.personal_data.email;
                    document.getElementById('modal-personal-phone').innerText = data.personal_data.phone;
                    document.getElementById('modal-personal-rut').innerText = data.personal_data.rut || 'No ingresado';
                    document.getElementById('modal-personal-location').innerText = data.personal_data.location;
                    document.getElementById('modal-personal-age').innerText = data.personal_data.age ? `${data.personal_data.age} años` : 'N/A';
                    document.getElementById('modal-personal-availability').innerText = data.personal_data.availability;
                    
                    if (data.personal_data.linkedin_url) {
                        personalLinkedin.href = data.personal_data.linkedin_url;
                        personalLinkedin.innerText = 'Ver Perfil'; // Make the link visible
                        linkedinContainer.classList.remove('hidden');
                    }

                    // Populate CV content
                    if (data.cv_data.cv_type === 'subido') {
                        const pdfIframe = document.createElement('iframe');
                        pdfIframe.src = data.cv_data.content;
                        pdfIframe.className = 'w-full h-full min-h-[80vh]';
                        
                        pdfIframe.addEventListener('load', () => {
                            hideLoader(cvPreviewModalEl);
                            if(cvModalBody) cvModalBody.classList.remove('hidden');
                        });
                        pdfIframe.addEventListener('error', () => {
                            cvContentArea.innerHTML = `<p class="text-red-500">Error al cargar el PDF.</p>`;
                            hideLoader(cvPreviewModalEl);
                            if(cvModalBody) cvModalBody.classList.remove('hidden');
                        });
                        cvContentArea.appendChild(pdfIframe);

                    } else { // 'creado'
                        const cv = data.cv_data.content;
                        let createdCvHtml = '';

                        // Helper to check if a section has content
                        const hasContent = (arr) => arr && Array.isArray(arr) && arr.length > 0;

                        // Objective
                        if (cv.objective) {
                            createdCvHtml += `<div class="mb-6"><h4 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">Objetivo Profesional</h4><p class="text-gray-600">${cv.objective}</p></div>`;
                        }

                        // Experience
                        if (hasContent(cv.experience)) {
                            createdCvHtml += `<div class="mb-6"><h4 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">Experiencia Laboral</h4>`;
                            cv.experience.forEach(exp => {
                                createdCvHtml += `<div class="mb-4"><p class="font-semibold text-gray-700">${exp.position} en ${exp.company}</p><p class="text-sm text-gray-500">${exp.start_date} - ${exp.end_date} &middot; ${exp.location}</p>`;
                                if (exp.description) {
                                    createdCvHtml += `<ul class="list-disc list-inside mt-1 text-sm text-gray-600">`;
                                    exp.description.split('\n').forEach(line => {
                                        if(line.trim()) createdCvHtml += `<li>${line.trim()}</li>`;
                                    });
                                    createdCvHtml += `</ul>`;
                                }
                                createdCvHtml += `</div>`;
                            });
                            createdCvHtml += `</div>`;
                        }

                        // Education
                        if (hasContent(cv.education)) {
                            createdCvHtml += `<div class="mb-6"><h4 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">Educación</h4>`;
                            cv.education.forEach(edu => {
                                createdCvHtml += `<div class="mb-3"><p class="font-semibold text-gray-700">${edu.degree} en ${edu.institution}</p><p class="text-sm text-gray-500">${edu.start_year} - ${edu.end_year}</p></div>`;
                            });
                            createdCvHtml += `</div>`;
                        }

                        // Skills
                        if (cv.skills && (hasContent(cv.skills.hard) || hasContent(cv.skills.soft))) {
                            createdCvHtml += `<div class="mb-6"><h4 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">Habilidades</h4>`;
                            if (hasContent(cv.skills.hard)) {
                                createdCvHtml += `<p class="font-medium text-gray-700 mb-1">Técnicas</p><ul class="list-disc list-inside text-sm text-gray-600 mb-3">`;
                                cv.skills.hard.forEach(skill => { createdCvHtml += `<li>${skill}</li>`; });
                                createdCvHtml += `</ul>`;
                            }
                            if (hasContent(cv.skills.soft)) {
                                createdCvHtml += `<p class="font-medium text-gray-700 mb-1">Blandas</p><ul class="list-disc list-inside text-sm text-gray-600">`;
                                cv.skills.soft.forEach(skill => { createdCvHtml += `<li>${skill}</li>`; });
                                createdCvHtml += `</ul>`;
                            }
                            createdCvHtml += `</div>`;
                        }
                        
                        // Languages
                        if (hasContent(cv.languages)) {
                            createdCvHtml += `<div class="mb-6"><h4 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">Idiomas</h4>`;
                            cv.languages.forEach(lang => {
                                createdCvHtml += `<p class="text-sm text-gray-600"><span class="font-semibold">${lang.language}:</span> ${lang.level}</p>`;
                            });
                            createdCvHtml += `</div>`;
                        }

                        // Certifications
                        if (hasContent(cv.certifications)) {
                            createdCvHtml += `<div class="mb-6"><h4 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">Certificaciones</h4>`;
                            cv.certifications.forEach(cert => {
                                createdCvHtml += `<div class="mb-3"><p class="font-semibold text-gray-700">${cert.cert_name} - ${cert.issuer}</p><p class="text-sm text-gray-500">Obtenido en: ${cert.year}</p></div>`;
                            });
                            createdCvHtml += `</div>`;
                        }

                        // Projects
                        if (hasContent(cv.projects)) {
                            createdCvHtml += `<div class="mb-6"><h4 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">Proyectos</h4>`;
                            cv.projects.forEach(proj => {
                                createdCvHtml += `<div class="mb-4"><p class="font-semibold text-gray-700">${proj.project_name} (${proj.period})</p><p class="text-sm text-gray-600">${proj.description}</p>${proj.link ? `<a href="${proj.link}" target="_blank" class="text-sm text-primary hover:underline">Ver proyecto</a>` : ''}</div>`;
                            });
                            createdCvHtml += `</div>`;
                        }

                        // References
                        if (hasContent(cv.references)) {
                            createdCvHtml += `<div class="mb-6"><h4 class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">Referencias</h4>`;
                            cv.references.forEach(ref => {
                                createdCvHtml += `<div class="mb-3"><p class="font-semibold text-gray-700">${ref.name}, ${ref.position}</p><p class="text-sm text-gray-600">Email: ${ref.email} | Tel: ${ref.phone}</p></div>`;
                            });
                            createdCvHtml += `</div>`;
                        }

                        cvContentArea.innerHTML = createdCvHtml;
                        hideLoader(cvPreviewModalEl);
                        if(cvModalBody) cvModalBody.classList.remove('hidden');
                    }
                } else {
                    throw new Error(result.message);
                }
            })
            .catch(error => {
                console.error('Fetch error for CV details:', error);
                cvContentArea.innerHTML = `<p class="text-red-500">Ocurrió un error al cargar el CV.</p>`;
                hideLoader(cvPreviewModalEl);
                if(cvModalBody) cvModalBody.classList.remove('hidden');
            });
    }

    function openScheduleModal(postulacionId) {
        currentPostulacionId = postulacionId;
        document.getElementById('schedule-interview-form').reset();
        scheduleModal.show();
    }

    function openManageModal(postulacionId) {
        currentPostulacionId = postulacionId;
        manageModal.show();
        showLoader(manageModalEl);
        fetch(`/api/postulacion/${postulacionId}/interview/details/`)
            .then(res => {
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                return res.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    const details = data.details;
                    currentInterviewId = details.interview_id;
                    const container = document.getElementById('interview-details-container');
                    container.innerHTML = `<p><strong>Fecha:</strong> ${details.fecha_display}</p><p><strong>Hora:</strong> ${details.hora_display}</p><p><strong>Modalidad:</strong> ${details.modalidad}</p>${details.plataforma ? `<p><strong>Plataforma:</strong> ${details.plataforma}</p>` : ''}${details.url ? `<p><strong>URL:</strong> <a href="${details.url}" target="_blank" class="text-primary hover:underline">Abrir enlace</a></p>` : ''}${details.direccion ? `<p><strong>Dirección:</strong> ${details.direccion}</p>` : ''}`;
                    document.getElementById('manage-interview-view').classList.remove('hidden');
                    document.getElementById('manage-interview-footer').classList.remove('hidden');
                    document.getElementById('reschedule-interview-form').classList.add('hidden');
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                console.error('Fetch error for interview details:', error);
                alert('Ocurrió un error al cargar los detalles de la entrevista.');
                manageModal.hide();
            })
            .finally(() => {
                hideLoader(manageModalEl);
            });
    }

    // 5. EVENT LISTENERS
    document.getElementById('kanban-container').addEventListener('click', function(event) {
        const targetButton = event.target.closest('button');
        if (!targetButton) return;
        const postulacionId = targetButton.dataset.postulacionId;
        if (!postulacionId) return;

        if (targetButton.classList.contains('view-cv-btn')) openCvModal(postulacionId);
        else if (targetButton.classList.contains('schedule-interview-btn')) openScheduleModal(postulacionId);
        else if (targetButton.classList.contains('manage-interview-btn')) openManageModal(postulacionId);
    });

    document.getElementById('auto-mode-toggle').addEventListener('change', function() {
        isAutoModeEnabled = this.checked;
    });

    // --- Combined Filtering Logic ---
    const searchInput = document.getElementById('applicant-search-filter');
    const availabilityContainer = document.getElementById('availability-filter-container');

    function applyAllFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const availabilityFilter = availabilityContainer.querySelector('input[name="availability"]:checked').value;

        document.querySelectorAll('.kanban-card').forEach(card => {
            const applicantName = card.querySelector('.font-semibold').textContent.toLowerCase();
            const availabilitySpan = card.querySelector('.availability-span');
            const applicantAvailability = availabilitySpan ? availabilitySpan.textContent.trim() : '';

            // Check conditions
            const nameMatch = applicantName.includes(searchTerm);
            const availabilityMatch = (availabilityFilter === 'todos') || (applicantAvailability === availabilityFilter);

            // Show card only if all conditions are met
            if (nameMatch && availabilityMatch) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
        
        // Update "empty" placeholders after filtering
        updateAllPlaceholders();
    }

    // Attach event listeners to call the master filter function
    searchInput.addEventListener('input', applyAllFilters);
    availabilityContainer.addEventListener('change', applyAllFilters);


    document.getElementById('status-filter-container').addEventListener('change', function(e) {
        if (e.target.type === 'checkbox') {
            const statusKey = e.target.value;
            const column = document.querySelector(`.kanban-column[data-status-key='${statusKey}']`);
            if (column) {
                column.classList.toggle('hidden', !e.target.checked);
            }
        }
    });

    document.getElementById('move-unavailable-btn').addEventListener('click', function() {
        const unavailableCards = Array.from(document.querySelectorAll('.kanban-card')).filter(card => {
            const availabilitySpan = card.querySelector('.availability-span');
            // Process only visible cards
            return card.style.display !== 'none' && availabilitySpan && availabilitySpan.textContent.trim() === 'No Disponible';
        });

        if (unavailableCards.length === 0) {
            alert('No hay postulantes "No Disponibles" visibles para mover.');
            return;
        }

        if (confirm(`¿Estás seguro de que quieres mover ${unavailableCards.length} postulante(s) a "Rechazados"?`)) {
            const promises = unavailableCards.map(card => {
                const postulacionId = card.dataset.id;
                return fetch(`/api/postulacion/${postulacionId}/update_status/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    body: JSON.stringify({ new_status: 'rechazada' })
                }).then(res => {
                    if (!res.ok) {
                        // If a request fails, throw an error to be caught by Promise.all
                        return res.json().then(err => Promise.reject(err));
                    }
                    return res.json();
                });
            });

            Promise.all(promises)
                .then(() => {
                    const rejectedColumn = document.querySelector('.kanban-cards[data-status="rechazada"]');
                    if (rejectedColumn) {
                        unavailableCards.forEach(card => {
                            rejectedColumn.appendChild(card);
                            updateCardUI(card); // Update buttons on the card
                        });
                    }
                    updateAllPlaceholders();
                    updateColumnCounts();
                    alert(`${unavailableCards.length} postulante(s) han sido movidos a "Rechazados".`);
                })
                .catch(error => {
                    console.error('Error en la acción en lote:', error);
                    alert('Ocurrió un error al mover uno o más postulantes. Por favor, recarga la página e inténtalo de nuevo.');
                });
        }
    });

    // --- Logic for Manage/Reschedule Modal ---
    const manageModalTitle = document.getElementById('manage-modal-title');
    const manageDetailsView = document.getElementById('manage-interview-view');
    const manageFormView = document.getElementById('reschedule-interview-form');

    document.getElementById('reschedule-btn').addEventListener('click', () => {
        manageDetailsView.classList.add('hidden');
        manageFormView.classList.remove('hidden');
        manageModalTitle.textContent = 'Reagendar Entrevista';
    });

    document.getElementById('cancel-reschedule-btn').addEventListener('click', () => {
        manageFormView.classList.add('hidden');
        manageDetailsView.classList.remove('hidden');
        manageModalTitle.textContent = 'Gestionar Entrevista';
    });

    document.getElementById('reschedule-interview-modality').addEventListener('change', function() {
        const onlineFields = document.getElementById('reschedule-online-fields');
        const presencialFields = document.getElementById('reschedule-presencial-fields');
        if (this.value === 'Online') {
            onlineFields.classList.remove('hidden');
            presencialFields.classList.add('hidden');
        } else {
            onlineFields.classList.add('hidden');
            presencialFields.classList.remove('hidden');
        }
    });


    // All form submissions (schedule, reschedule, delete)
    document.getElementById('schedule-interview-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        fetch(`/api/postulacion/${currentPostulacionId}/schedule_interview/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify(data)
        }).then(res => res.json()).then(result => {
            if (result.status === 'success') {
                alert('Entrevista agendada.');
                scheduleModal.hide();
                const card = document.querySelector(`.kanban-card[data-id='${currentPostulacionId}']`);
                card.dataset.hasInterview = 'true';
                const toCol = document.querySelector(`.kanban-cards[data-status='entrevista']`);
                if (card.parentElement !== toCol) toCol.appendChild(card);
                updateCardUI(card);
                updateAllPlaceholders();
                updateColumnCounts();
            } else { alert(`Error: ${result.message}`); }
        });
    });

    document.getElementById('delete-interview-btn').addEventListener('click', function() {
        if (confirm('¿Estás seguro? El postulante pasará a "Rechazados" y se le notificará por correo.')) {
            fetch(`/api/interview/${currentInterviewId}/delete/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken }
            }).then(res => res.json()).then(result => {
                if (result.status === 'success') {
                    alert('Entrevista eliminada.');
                    manageModal.hide();
                    const card = document.querySelector(`.kanban-card[data-id='${currentPostulacionId}']`);
                    card.dataset.hasInterview = 'false';
                    const toCol = document.querySelector(`.kanban-cards[data-status='rechazada']`);
                    if (card.parentElement !== toCol) toCol.appendChild(card);
                    updateCardUI(card);
                    updateAllPlaceholders();
                    updateColumnCounts();
                } else { alert(`Error: ${result.message}`); }
            });
        }
    });
    
		document.getElementById('reschedule-interview-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        fetch(`/api/postulacion/${currentPostulacionId}/schedule_interview/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify(data)
        }).then(res => res.json()).then(result => {
            if (result.status === 'success') {
                alert('Entrevista Re-agendada.');
                scheduleModal.hide();
                const card = document.querySelector(`.kanban-card[data-id='${currentPostulacionId}']`);
                card.dataset.hasInterview = 'true';
                const toCol = document.querySelector(`.kanban-cards[data-status='entrevista']`);
                if (card.parentElement !== toCol) toCol.appendChild(card);
                updateCardUI(card);
                updateAllPlaceholders();
                updateColumnCounts();
								document.getElementById('manage-interview-btn').click();
            } else { alert(`Error: ${result.message}`); }
        });
    });

    // ... other form listeners ...

    // 6. DRAG & DROP
    document.querySelectorAll('.kanban-cards').forEach(container => {
        new Sortable(container, {
            group: 'kanban',
            animation: 150,
            onEnd: function (evt) {
                const card = evt.item;
                const fromColumnContainer = evt.from;
                const toColumnContainer = evt.to;
                
                const postulacionId = card.dataset.id;
                const newStatus = toColumnContainer.dataset.status;

                fetch(`/api/postulacion/${postulacionId}/update_status/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    body: JSON.stringify({ new_status: newStatus })
                }).then(res => res.json()).then(data => {
                    if (data.status === 'success') {
                        updateCardUI(card);
                        if (isAutoModeEnabled) {
                            if (newStatus === 'entrevista' && card.dataset.hasInterview === 'false') {
                                openScheduleModal(postulacionId);
                            } else if (newStatus === 'entrevista' && card.dataset.hasInterview === 'true') {
                                openManageModal(postulacionId);
                            } else if (newStatus !== 'entrevista') {
                                openCvModal(postulacionId);
                            }
                        }
                    } else {
                        fromColumnContainer.appendChild(card); // Revert on failure
                        updateCardUI(card);
                    }
                }).finally(() => {
                    updateAllPlaceholders();
                    updateColumnCounts();
                });
            }
        });
    });

    // Initial UI setup
    updateColumnCounts();
    updateAllPlaceholders();
});
</script>
{% endblock %}